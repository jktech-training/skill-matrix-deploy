# This workflow routes deployment requests to the appropriate workflow
# Place in PUBLIC repository: jktech-training/skill-matrix-deploy
#
# Usage from private repo (via repository_dispatch):
# - Full deployment: Trigger "trigger-from-private" with deployment_type: "full" (or omit)
# - Backend only: Trigger "trigger-from-private" with deployment_type: "backend"
# - Frontend only: Trigger "trigger-from-private" with deployment_type: "frontend"
#
# Or trigger specific workflows directly:
# - "deploy-backend" for backend only
# - "deploy-frontend" for frontend only
# - "deploy-full" for full deployment

name: Deployment Router

on:
  repository_dispatch:
    types: [trigger-from-private, deploy-full, deploy-frontend, deploy-backend]

jobs:
  determine-deployment:
    runs-on: ubuntu-latest
    outputs:
      deployment_type: ${{ steps.determine.outputs.deployment_type }}
      repository: ${{ steps.determine.outputs.repository }}
      branch: ${{ steps.determine.outputs.branch }}
    steps:
      - name: Determine Deployment Type
        id: determine
        run: |
          # Get deployment type from event or payload
          if [[ "${{ github.event.action }}" == "deploy-backend" ]]; then
            DEPLOYMENT_TYPE="backend"
          elif [[ "${{ github.event.action }}" == "deploy-frontend" ]]; then
            DEPLOYMENT_TYPE="frontend"
          elif [[ "${{ github.event.action }}" == "deploy-full" ]]; then
            DEPLOYMENT_TYPE="full"
          else
            # Default from payload or default to full
            DEPLOYMENT_TYPE="${{ github.event.client_payload.deployment_type || 'full' }}"
          fi
          
          echo "deployment_type=$DEPLOYMENT_TYPE" >> $GITHUB_OUTPUT
          echo "Deployment type: $DEPLOYMENT_TYPE"
          
          REPO="${{ github.event.client_payload.repository || 'jktech-training/skill-matrix-V2' }}"
          BRANCH="${{ github.event.client_payload.ref || 'main' }}"
          echo "repository=$REPO" >> $GITHUB_OUTPUT
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT

  deploy-backend:
    needs: determine-deployment
    if: needs.determine-deployment.outputs.deployment_type == 'backend' || needs.determine-deployment.outputs.deployment_type == 'full'
    uses: ./.github/workflows/backend-deployment.yml
    with:
      repository: ${{ needs.determine-deployment.outputs.repository }}
      branch: ${{ needs.determine-deployment.outputs.branch }}
      deployment_type: ${{ needs.determine-deployment.outputs.deployment_type }}

  deploy-frontend:
    needs: determine-deployment
    if: needs.determine-deployment.outputs.deployment_type == 'frontend' || needs.determine-deployment.outputs.deployment_type == 'full'
    uses: ./.github/workflows/frontend-deployment.yml
    with:
      repository: ${{ needs.determine-deployment.outputs.repository }}
      branch: ${{ needs.determine-deployment.outputs.branch }}
      deployment_type: ${{ needs.determine-deployment.outputs.deployment_type }}
