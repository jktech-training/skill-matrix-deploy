name: Deploy Frontend

on:
  repository_dispatch:
    types: [deploy-frontend, trigger-from-private]
  workflow_dispatch:
    inputs:
      repository:
        required: false
        type: string
        default: 'jktech-training/skill-matrix-V2'
      branch:
        required: false
        type: string
        default: 'main'
      deployment_type:
        required: false
        type: choice
        options:
          - backend
          - frontend
          - full
        default: 'frontend'
  workflow_call:
    inputs:
      repository:
        required: false
        type: string
        default: 'jktech-training/skill-matrix-V2'
      branch:
        required: false
        type: string
        default: 'main'
      deployment_type:
        required: false
        type: string
        default: 'frontend'

jobs:
  deploy-frontend:
    runs-on: ubuntu-latest
    
    steps:
      - name: Extract Repository Info
        id: repo-info
        run: |
          if [[ "${{ github.event_name }}" == "workflow_call" ]]; then
            REPO="${{ inputs.repository }}"
            BRANCH="${{ inputs.branch }}"
          else
            REPO="${{ github.event.client_payload.repository || github.event.inputs.repository || 'jktech-training/skill-matrix-V2' }}"
            BRANCH="${{ github.event.client_payload.ref || github.event.inputs.branch || 'main' }}"
          fi
          echo "repository=$REPO" >> $GITHUB_OUTPUT
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT

      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          repository: ${{ steps.repo-info.outputs.repository }}
          ref: ${{ steps.repo-info.outputs.branch }}
          token: ${{ secrets.PRIVATETOKENPULL }}

      - name: Setup Environment
        id: env
        uses: ./.github/actions/setup-environment
        with:
          repository: ${{ steps.repo-info.outputs.repository }}
          branch: ${{ steps.repo-info.outputs.branch }}

      - name: Detect Frontend Changes
        id: changes
        uses: ./.github/actions/detect-changes
        with:
          branch: ${{ steps.repo-info.outputs.branch }}
          path: frontend

      - name: Setup Google Cloud
        if: steps.changes.outputs.has_changes == 'true'
        uses: ./.github/actions/setup-gcp
        with:
          gcp_sakey: ${{ secrets.GCP_SAKEY }}
          project_id: training-project-419308

      - name: Skip Deployment - No Changes Detected
        if: steps.changes.outputs.has_changes != 'true'
        run: |
          echo "⏭️  No changes detected in frontend/ directory"
          echo "Skipping frontend deployment"

      - name: Set Docker Image Name and Tag
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          IMAGE_SUFFIX="${{ steps.env.outputs.image_suffix }}"
          IMAGE_NAME="frontend-ui${IMAGE_SUFFIX}"
          TAG=$(date +%Y%m%d-%H%M%S)
          echo "IMAGE_NAME=$IMAGE_NAME" >> $GITHUB_ENV
          echo "TAG=$TAG" >> $GITHUB_ENV
          echo "Full image: asia-south1-docker.pkg.dev/training-project-419308/skill-matrix/${IMAGE_NAME}:${TAG}"

      - name: Build and Push Docker Image
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          docker build \
            --build-arg VITE_BASE_URL="${{ secrets.VITE_BASE_URL }}" \
            --build-arg VITE_SSO_URL="${{ secrets.VITE_SSO_URL }}" \
            -t asia-south1-docker.pkg.dev/training-project-419308/skill-matrix/${IMAGE_NAME}:${TAG} \
            ./frontend
          gcloud auth configure-docker asia-south1-docker.pkg.dev --quiet
          docker push asia-south1-docker.pkg.dev/training-project-419308/skill-matrix/${IMAGE_NAME}:${TAG}
      
      - name: Deploy Frontend to Cloud Run
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          CLOUD_RUN_SERVICE="${{ steps.env.outputs.cloud_run_service }}"
          gcloud run deploy ${CLOUD_RUN_SERVICE} \
            --image=asia-south1-docker.pkg.dev/training-project-419308/skill-matrix/${IMAGE_NAME}:${TAG} \
            --platform=managed \
            --region=asia-south1 \
            --allow-unauthenticated \
            --quiet

          gcloud run services add-iam-policy-binding ${CLOUD_RUN_SERVICE} \
            --member="allUsers" \
            --role="roles/run.invoker" \
            --region=asia-south1 \
            --platform=managed \
            --quiet
